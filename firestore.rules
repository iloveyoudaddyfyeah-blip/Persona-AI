/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model. Users can only read and write data
 * that belongs to them. Data validation is relaxed to allow for rapid prototyping.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile data.
 * - /users/{userId}/characters/{characterId}: Stores character profiles created by each user.
 * - /users/{userId}/personas/{personaId}: Stores user-defined personas.
 *
 * Key Security Decisions:
 * - Users can only access their own data. No cross-user data access is allowed.
 * - Listing of users is disallowed.
 *
 * Denormalization for Authorization:
 * The rules rely on path-based authorization, assuming that the `userId` in the path
 * matches the authenticated user's UID. The `id` field within the documents stored under
 * user paths must also match the `userId`, enforced on creation and immutability on update to
 * prevent privilege escalation.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile documents.
     * @path /users/{userId}
     * @allow (create) - User with UID 'user_abc' can create their own profile document with `id: 'user_abc'`.
     * @allow (get, update, delete) - User with UID 'user_abc' can read, update, and delete their own profile document.
     * @deny (create) - User with UID 'user_abc' cannot create a profile document with `id: 'other_user'`.
     * @deny (get, update, delete) - User with UID 'user_xyz' cannot read, update, or delete the profile document of user 'user_abc'.
     * @principle Enforces document ownership and relational integrity for user profiles.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false; // Listing users is not permitted.
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to character profiles within a user's collection.
     * @path /users/{userId}/characters/{characterId}
     * @allow (create) - User with UID 'user_abc' can create a character profile under their user document.
     * @allow (get, list, update, delete) - User with UID 'user_abc' can read, list, update, and delete character profiles under their user document.
     * @deny (create) - User with UID 'user_xyz' cannot create a character profile under user 'user_abc'.
     * @deny (get, list, update, delete) - User with UID 'user_xyz' cannot read, list, update, or delete character profiles under user 'user_abc'.
     * @principle Enforces document ownership for character profiles.
     */
    match /users/{userId}/characters/{characterId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to user personas within a user's collection.
     * @path /users/{userId}/personas/{personaId}
     * @allow (create) - User with UID 'user_abc' can create a persona under their user document.
     * @allow (get, list, update, delete) - User with UID 'user_abc' can read, list, update, and delete personas under their user document.
     * @deny (create) - User with UID 'user_xyz' cannot create a persona under user 'user_abc'.
     * @deny (get, list, update, delete) - User with UID 'user_xyz' cannot read, list, update, or delete personas under user 'user_abc'.
     * @principle Enforces document ownership for user personas.
     */
    match /users/{userId}/personas/{personaId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}