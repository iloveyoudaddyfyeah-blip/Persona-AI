/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model. Each user can only
 * access their own data, which is nested under their respective `/users/{userId}`
 * path.
 *
 * Data Structure:
 * The Firestore database is structured as follows:
 * - `/users/{userId}`: User profiles.
 * - `/users/{userId}/characters/{characterId}`: Character profiles created by the user.
 * - `/users/{userId}/characters/{characterId}/chatSessions/{chatSessionId}`: Chat sessions for a character profile.
 * - `/users/{userId}/characters/{characterId}/chatSessions/{chatSessionId}/chatMessages/{chatMessageId}`: Chat messages within a chat session.
 *
 * Key Security Decisions:
 * - User listing is disallowed for privacy.
 * - All data is private and requires authentication.
 * - Rules leverage path-based ownership for simplicity and performance.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secure user profiles. Only the user can access their own profile.
     * @path /users/{userId}
     * @allow (create) - User with ID 'user123' can create a profile with ID 'user123'.
     * @allow (get, update, delete) - User with ID 'user123' can get, update, or delete their own profile (ID 'user123').
     * @deny (create) - User with ID 'user456' cannot create a profile with ID 'user123'.
     * @deny (get, update, delete) - User with ID 'user456' cannot get, update, or delete the profile of user 'user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secure character profiles. Only the user who owns the profile can access it.
     * @path /users/{userId}/characters/{characterId}
     * @allow (create) - User with ID 'user123' can create a character profile under their user ID.
     * @allow (get, update, delete) - User with ID 'user123' can get, update, or delete their own character profiles.
     * @deny (create) - User with ID 'user456' cannot create a character profile under user 'user123'.
     * @deny (get, update, delete) - User with ID 'user456' cannot get, update, or delete character profiles owned by user 'user123'.
     * @principle Enforces path-based ownership.
     */
    match /users/{userId}/characters/{characterId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secure chat sessions. Only the user who owns the character profile can access the chat sessions.
     * @path /users/{userId}/characters/{characterId}/chatSessions/{chatSessionId}
     * @allow (create) - User with ID 'user123' can create a chat session under their character profile.
     * @allow (get, update, delete) - User with ID 'user123' can get, update, or delete their own chat sessions.
     * @deny (create) - User with ID 'user456' cannot create a chat session under user 'user123''s character profile.
     * @deny (get, update, delete) - User with ID 'user456' cannot get, update, or delete chat sessions owned by user 'user123'.
     * @principle Enforces path-based ownership.
     */
    match /users/{userId}/characters/{characterId}/chatSessions/{chatSessionId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secure chat messages. Only the user who owns the chat session can access the chat messages.
     * @path /users/{userId}/characters/{characterId}/chatSessions/{chatSessionId}/chatMessages/{chatMessageId}
     * @allow (create) - User with ID 'user123' can create a chat message under their chat session.
     * @allow (get, update, delete) - User with ID 'user123' can get, update, or delete their own chat messages.
     * @deny (create) - User with ID 'user456' cannot create a chat message under user 'user123''s chat session.
     * @deny (get, update, delete) - User with ID 'user456' cannot get, update, or delete chat messages owned by user 'user123'.
     * @principle Enforces path-based ownership.
     */
    match /users/{userId}/characters/{characterId}/chatSessions/{chatSessionId}/chatMessages/{chatMessageId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}