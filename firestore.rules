/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model.  Each user has full control
 * over their own data, and no access to other users' data unless explicitly granted
 * through a shared access pattern (not currently implemented).
 *
 * Data Structure:
 * Data is nested under `/users/{userId}`, creating a clear ownership hierarchy.
 * Character profiles, chat sessions, and chat messages are all subcollections
 * of the user's document.
 *
 * Key Security Decisions:
 * - Users can only create, read, update, and delete their own profiles.
 * - User listing is disallowed as there is no need for it in the app, and could expose emails.
 * - Data validation is relaxed in this prototype to allow faster iteration,
 *   but authorization is strictly enforced based on user ID.
 * - No public read access is granted.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profiles.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their own profile.
     *   Request: { auth: { uid: 'user123' }, method: 'create', path: '/databases/(default)/documents/users/user123' }
     * @allow (get) User with ID 'user123' can read their own profile.
     *   Request: { auth: { uid: 'user123' }, method: 'get', path: '/databases/(default)/documents/users/user123' }
     * @allow (update) User with ID 'user123' can update their own profile.
     *   Request: { auth: { uid: 'user123' }, method: 'update', path: '/databases/(default)/documents/users/user123' }
     * @allow (delete) User with ID 'user123' can delete their own profile.
     *   Request: { auth: { uid: 'user123' }, method: 'delete', path: '/databases/(default)/documents/users/user123' }
     * @deny (create) User with ID 'user456' cannot create a profile for user 'user123'.
     *   Request: { auth: { uid: 'user456' }, method: 'create', path: '/databases/(default)/documents/users/user123' }
     * @deny (get) User with ID 'user456' cannot read user 'user123's profile.
     *   Request: { auth: { uid: 'user456' }, method: 'get', path: '/databases/(default)/documents/users/user123' }
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    

        /**
         * @description Controls access to character profiles nested under a user.
         * @path /users/{userId}/characters/{characterId}
         * @allow (create) User with ID 'user123' can create a character profile under their ID.
         *   Request: { auth: { uid: 'user123' }, method: 'create', path: '/databases/(default)/documents/users/user123/characters/char1' }
         * @allow (get) User with ID 'user123' can read their own character profile.
         *   Request: { auth: { uid: 'user123' }, method: 'get', path: '/databases/(default)/documents/users/user123/characters/char1' }
         * @allow (update) User with ID 'user123' can update their own character profile.
         *   Request: { auth: { uid: 'user123' }, method: 'update', path: '/databases/(default)/documents/users/user123/characters/char1' }
         * @allow (delete) User with ID 'user123' can delete their own character profile.
         *   Request: { auth: { uid: 'user123' }, method: 'delete', path: '/databases/(default)/documents/users/user123/characters/char1' }
         * @deny (create) User with ID 'user456' cannot create a character profile for user 'user123'.
         *   Request: { auth: { uid: 'user456' }, method: 'create', path: '/databases/(default)/documents/users/user123/characters/char1' }
         * @deny (get) User with ID 'user456' cannot read user 'user123's character profile.
         *   Request: { auth: { uid: 'user456' }, method: 'get', path: '/databases/(default)/documents/users/user123/characters/char1' }
         * @principle Enforces document ownership for all operations within the user's data tree.
         */
        match /characters/{characterId} {
          allow get: if isOwner(userId);
          allow list: if false;
          allow create: if isOwner(userId);
          allow update: if isOwner(userId);
          allow delete: if isOwner(userId);

            /**
             * @description Controls access to chat sessions nested under a character profile.
             * @path /users/{userId}/characters/{characterId}/chatSessions/{chatSessionId}
             * @allow (create) User with ID 'user123' can create a chat session under their character profile.
             *   Request: { auth: { uid: 'user123' }, method: 'create', path: '/databases/(default)/documents/users/user123/characters/char1/chatSessions/session1' }
             * @allow (get) User with ID 'user123' can read their own chat session.
             *   Request: { auth: { uid: 'user123' }, method: 'get', path: '/databases/(default)/documents/users/user123/characters/char1/chatSessions/session1' }
             * @allow (update) User with ID 'user123' can update their own chat session.
             *   Request: { auth: { uid: 'user123' }, method: 'update', path: '/databases/(default)/documents/users/user123/characters/char1/chatSessions/session1' }
             * @allow (delete) User with ID 'user123' can delete their own chat session.
             *   Request: { auth: { uid: 'user123' }, method: 'delete', path: '/databases/(default)/documents/users/user123/characters/char1/chatSessions/session1' }
             * @deny (create) User with ID 'user456' cannot create a chat session for user 'user123'.
             *   Request: { auth: { uid: 'user456' }, method: 'create', path: '/databases/(default)/documents/users/user123/characters/char1/chatSessions/session1' }
             * @deny (get) User with ID 'user456' cannot read user 'user123's chat session.
             *   Request: { auth: { uid: 'user456' }, method: 'get', path: '/databases/(default)/documents/users/user123/characters/char1/chatSessions/session1' }
             * @principle Enforces document ownership for all operations within the user's data tree.
             */
            match /chatSessions/{chatSessionId} {
              allow get: if isOwner(userId);
              allow list: if false;
              allow create: if isOwner(userId);
              allow update: if isOwner(userId);
              allow delete: if isOwner(userId);

                /**
                 * @description Controls access to chat messages nested under a chat session.
                 * @path /users/{userId}/characters/{characterId}/chatSessions/{chatSessionId}/chatMessages/{chatMessageId}
                 * @allow (create) User with ID 'user123' can create a chat message under their chat session.
                 *   Request: { auth: { uid: 'user123' }, method: 'create', path: '/databases/(default)/documents/users/user123/characters/char1/chatSessions/session1/chatMessages/message1' }
                 * @allow (get) User with ID 'user123' can read their own chat message.
                 *   Request: { auth: { uid: 'user123' }, method: 'get', path: '/databases/(default)/documents/users/user123/characters/char1/chatSessions/session1/chatMessages/message1' }
                 * @allow (update) User with ID 'user123' can update their own chat message.
                 *   Request: { auth: { uid: 'user123' }, method: 'update', path: '/databases/(default)/documents/users/user123/characters/char1/chatSessions/session1/chatMessages/message1' }
                 * @allow (delete) User with ID 'user123' can delete their own chat message.
                 *   Request: { auth: { uid: 'user123' }, method: 'delete', path: '/databases/(default)/documents/users/user123/characters/char1/chatSessions/session1/chatMessages/message1' }
                 * @deny (create) User with ID 'user456' cannot create a chat message for user 'user123'.
                 *   Request: { auth: { uid: 'user456' }, method: 'create', path: '/databases/(default)/documents/users/user123/characters/char1/chatSessions/session1/chatMessages/message1' }
                 * @deny (get) User with ID 'user456' cannot read user 'user123's chat message.
                 *   Request: { auth: { uid: 'user456' }, method: 'get', path: '/databases/(default)/documents/users/user123/characters/char1/chatSessions/session1/chatMessages/message1' }
                 * @principle Enforces document ownership for all operations within the user's data tree.
                 */
                match /chatMessages/{chatMessageId} {
                  allow get: if isOwner(userId);
                  allow list: if false;
                  allow create: if isOwner(userId);
                  allow update: if isOwner(userId);
                  allow delete: if isOwner(userId);
                }
              }
            }
          }
        }
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
}