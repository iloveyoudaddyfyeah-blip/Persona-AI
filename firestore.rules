/**
 * @file Firestore Security Rules
 * @core_philosophy This ruleset enforces a strict user-ownership model. Users can only create, read, update, and delete data associated with their own user ID.
 * @data_structure All data is nested under /users/{userId}, ensuring clear ownership. Character profiles, chat sessions, and chat messages are all stored as subcollections of the user's document.
 * @key_security_decisions Listing of users is disallowed.  Write access is strictly controlled via the `isOwner()` function.  Schema validation is relaxed to allow prototyping.
 * @denormalization Not applicable in this simple user-ownership model.  All authorization is path-based.
 * @structural_segregation All user-specific data is kept under the /users/{userId} path, clearly separating private user data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profiles.
     * @path /databases/{database}/documents/users/{userId}
     * @allow (create) User 'testUser' can create their own profile with matching userId.
     * @deny (create) User 'otherUser' cannot create a profile with userId 'testUser'.
     * @allow (get) User 'testUser' can read their own profile.
     * @deny (get) User 'otherUser' cannot read user 'testUser' profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == request.auth.uid;
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Controls access to character profiles created by the user.
     * @path /databases/{database}/documents/users/{userId}/characters/{characterId}
     * @allow (create) User 'testUser' can create a character profile under their userId.
     * @deny (create) User 'otherUser' cannot create a character profile under userId 'testUser'.
     * @allow (get) User 'testUser' can read their own character profile.
     * @deny (get) User 'otherUser' cannot read user 'testUser' character profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/characters/{characterId} {
       function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Controls access to chat sessions for a specific character profile.
     * @path /databases/{database}/documents/users/{userId}/characters/{characterId}/chatSessions/{chatSessionId}
     * @allow (create) User 'testUser' can create a chat session under their character profile.
     * @deny (create) User 'otherUser' cannot create a chat session under userId 'testUser'.
     * @allow (get) User 'testUser' can read their own chat session.
     * @deny (get) User 'otherUser' cannot read user 'testUser' chat session.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/characters/{characterId}/chatSessions/{chatSessionId} {
       function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Controls access to chat messages for a specific chat session.
     * @path /databases/{database}/documents/users/{userId}/characters/{characterId}/chatSessions/{chatSessionId}/chatMessages/{chatMessageId}
     * @allow (create) User 'testUser' can create a chat message under their chat session.
     * @deny (create) User 'otherUser' cannot create a chat message under userId 'testUser'.
     * @allow (get) User 'testUser' can read their own chat message.
     * @deny (get) User 'otherUser' cannot read user 'testUser' chat message.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/characters/{characterId}/chatSessions/{chatSessionId}/chatMessages/{chatMessageId} {
       function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }
  }
}