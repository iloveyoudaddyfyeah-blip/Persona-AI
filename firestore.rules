/**
 * @fileoverview Firestore Security Rules for the Character Profile application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model. Each user has full control over their own data,
 * and no user can access another user's data. Data consistency is enforced by validating the user ID
 * in the path against the user ID stored within the document.
 *
 * Data Structure:
 * The Firestore database is structured as follows:
 * - /users/{userId}: Stores user profiles.
 * - /users/{userId}/characters/{characterId}: Stores character profiles created by each user.
 * - /users/{userId}/characters/{characterId}/chatSessions/{chatSessionId}: Stores chat sessions for each character profile.
 * - /users/{userId}/characters/{characterId}/chatSessions/{chatSessionId}/chatMessages/{chatMessageId}: Stores chat messages for each chat session.
 *
 * Key Security Decisions:
 * - Users can only read and write their own data.
 * - Listing of users is disallowed.
 * - Data consistency is enforced by matching the user ID in the path with the `userId` field in the document.
 * - Flexible data shapes are permitted to allow for rapid prototyping, but authorization is strictly enforced.
 * - Denormalization for Authorization:  The `userId` is present within the CharacterProfile documents, ChatSession and ChatMessage documents so that we can perform
 * authorization checks based on `resource.data.userId`.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Rules for the /users/{userId} collection.
     * @path /users/{userId}
     * @allow (create, update, get, delete) User with ID 'STzGlUZEvZgVu1z9uPSEQhG2DT92' can create/update/get/delete their own profile.
     * @deny (create, update, get, delete) User with ID 'OTHER_USER_ID' cannot create/update/get/delete the profile for user 'STzGlUZEvZgVu1z9uPSEQhG2DT92'.
     * @principle Enforces user-ownership: only the authenticated user can access their own profile.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the /users/{userId}/characters/{characterId} collection.
     * @path /users/{userId}/characters/{characterId}
     * @allow (create) User with ID 'STzGlUZEvZgVu1z9uPSEQhG2DT92' can create character profile in their own user profile.
     * @allow (get, list) User with ID 'STzGlUZEvZgVu1z9uPSEQhG2DT92' can get/list character profiles in their own user profile.
     * @allow (update, delete) User with ID 'STzGlUZEvZgVu1z9uPSEQhG2DT92' can update/delete character profiles in their own user profile.
     * @deny (create, update, get, delete, list) User with ID 'OTHER_USER_ID' cannot create/update/get/delete/list character profiles in user 'STzGlUZEvZgVu1z9uPSEQhG2DT92' profile.
     * @principle Enforces user-ownership: only the authenticated user can access their own character profiles.
     */
    match /users/{userId}/characters/{characterId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the /users/{userId}/characters/{characterId}/chatSessions/{chatSessionId} collection.
     * @path /users/{userId}/characters/{characterId}/chatSessions/{chatSessionId}
     * @allow (create) User with ID 'STzGlUZEvZgVu1z9uPSEQhG2DT92' can create chat sessions for their character profiles.
     * @allow (get, list) User with ID 'STzGlUZEvZgVu1z9uPSEQhG2DT92' can get/list chat sessions for their character profiles.
     * @allow (update, delete) User with ID 'STzGlUZEvZgVu1z9uPSEQhG2DT92' can update/delete chat sessions for their character profiles.
     * @deny (create, update, get, delete, list) User with ID 'OTHER_USER_ID' cannot create/update/get/delete/list chat sessions for user 'STzGlUZEvZgVu1z9uPSEQhG2DT92' character profiles.
     * @principle Enforces user-ownership: only the authenticated user can access their own chat sessions.
     */
    match /users/{userId}/characters/{characterId}/chatSessions/{chatSessionId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

     /**
      * @description Rules for the /users/{userId}/characters/{characterId}/chatSessions/{chatSessionId}/chatMessages/{chatMessageId} collection.
      * @path /users/{userId}/characters/{characterId}/chatSessions/{chatSessionId}/chatMessages/{chatMessageId}
      * @allow (create) User with ID 'STzGlUZEvZgVu1z9uPSEQhG2DT92' can create chat messages for their chat sessions.
      * @allow (get, list) User with ID 'STzGlUZEvZgVu1z9uPSEQhG2DT92' can get/list chat messages for their chat sessions.
      * @allow (update, delete) User with ID 'STzGlUZEvZgVu1z9uPSEQhG2DT92' can update/delete chat messages for their chat sessions.
      * @deny (create, update, get, delete, list) User with ID 'OTHER_USER_ID' cannot create/update/get/delete/list chat messages for user 'STzGlUZEvZgVu1z9uPSEQhG2DT92' chat sessions.
      * @principle Enforces user-ownership: only the authenticated user can access their own chat messages.
      */
    match /users/{userId}/characters/{characterId}/chatSessions/{chatSessionId}/chatMessages/{chatMessageId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}